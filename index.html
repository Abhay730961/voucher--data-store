<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voucher & Expenses Manager</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Defer heavy libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #6366f1;
      --primary-2: #818cf8;
      --accent: #14b8a6;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --border: #1f2937;
      --shadow: 0 8px 18px rgba(0,0,0,.18); /* lighter shadow */
      --radius: 12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#0b1020;color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* Navbar (no blur for performance) */
    .navbar{
      position: sticky; top:0; z-index:1000;
      background:#0b1020; /* solid background */
      border-bottom: 1px solid var(--border);
    }
    .nav-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--accent),#22d3ee)}
    .nav-links{display:flex;gap:10px;flex-wrap:wrap}
    .nav-links a{
      padding:10px 14px;border-radius:10px;border:1px solid transparent; color:var(--text);
    }
    .nav-links a.active, .nav-links a:hover{
      background:linear-gradient(180deg,rgba(99,102,241,.15),rgba(99,102,241,.05));
      border-color: rgba(99,102,241,.35);
    }
    .userbox{display:flex;align-items:center;gap:12px}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:none;background:var(--primary);color:white;padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow: var(--shadow);transition:.15s transform}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.ghost{background:transparent;color:var(--muted)}
    .btn.success{background:var(--success)}
    .btn.warn{background:var(--warning);color:#09251c}
    .btn.danger{background:var(--danger)}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:14px}

    /* Sections (no animations for instant paint) */
    section{display:none}
    section.active{display:block}

    /* Cards and panels */
    .panel{
      background: #0f172a;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .panel h3{margin:0 0 10px}
    .row{display:grid;gap:16px}
    .row.cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
    .row.cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
    .row.cols-4{grid-template-columns: repeat(4, minmax(0,1fr))}
    @media(max-width:900px){.row.cols-3,.row.cols-4{grid-template-columns: repeat(2, minmax(0,1fr))}}
    @media(max-width:640px){.row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns: 1fr}}

    /* Dashboard */
    .card{
      padding:16px;border-radius:14px;border:1px solid var(--border);background:#0f172a
    }
    .card .label{color:var(--muted);font-size:13px}
    .card .value{font-size:28px;font-weight:700;margin-top:4px}
    .chip{display:inline-flex;gap:8px; align-items:center; padding:6px 10px;border-radius:999px;border:1px dashed var(--border);font-size:12px;color:var(--muted)}

    /* Forms */
    form .grid{display:grid;gap:14px;grid-template-columns: repeat(12, 1fr)}
    form .col-12{grid-column: span 12}
    form .col-6{grid-column: span 6}
    form .col-4{grid-column: span 4}
    form .col-3{grid-column: span 3}
    form .col-2{grid-column: span 2}
    @media(max-width:900px){form .col-6{grid-column: span 12} form .col-4{grid-column: span 6} form .col-3{grid-column: span 6}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0a1126;color:var(--text);
      outline:none;transition:border-color .1s;
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(129,140,248,.6);box-shadow:0 0 0 2px rgba(99,102,241,.12)}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px; flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,rgba(34,211,238,.12),rgba(34,197,94,.05));border-color:rgba(20,184,166,.35)}

    /* Tables */
    .table-wrap{margin-top:16px}
    .table-tools{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .search{flex:1}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px;border:1px solid var(--border)}
    thead th{position:sticky;top:0;background:#0b132a;border-bottom:1px solid var(--border);font-weight:600;font-size:13px;color:var(--muted);text-align:left;padding:12px;cursor:pointer;user-select:none}
    tbody td{padding:12px;border-bottom:1px solid var(--border)}
    tbody tr:hover{background:rgba(99,102,241,.06)}
    tr.selected{outline:2px solid var(--primary-2);background:rgba(129,140,248,.08)}

    /* Login overlay (simple solid bg for performance) */
    .overlay{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background: rgba(2,6,23,.92);
      z-index: 2000;
    }
    .login-card{width:min(420px, calc(100% - 32px));padding:22px;border-radius:14px;background:#0f172a;border:1px solid var(--border);box-shadow: var(--shadow)}
    .login-card h2{margin:0 0 4px}
    .login-card p{margin:0 0 14px;color:var(--muted);font-size:14px}
    .hint{font-size:12px;color:var(--muted)}
    .error{color:#fecaca;font-size:13px;margin-top:6px;min-height:18px}

    /* Print */
    @media print{
      body{background:#fff;color:#000}
      .navbar,.no-print,.tabs{display:none !important}
      section{display:block !important}
      #print-area{display:block !important}
      .panel, .card, .table-wrap, .login-card{box-shadow:none;border: none}
    }
    #print-area{display:none}
    .voucher-print{max-width:720px;margin:0 auto;padding:24px;border:1px dashed #888;border-radius:8px;background:#fff;color:#000}
    .voucher-print h2{margin-top:0}
    .voucher-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .voucher-grid div{padding:6px 8px;border:1px solid #ddd;border-radius:6px;background:#fafafa}
  </style>
</head>
<body>

  <!-- Login Overlay -->
  <div class="overlay" id="loginOverlay" aria-modal="true" role="dialog">
    <div class="login-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h2>Welcome</h2>
        <span class="chip">Login Required</span>
      </div>
      <p>Sign in to access vouchers, expenses, dashboard, and admin panel.</p>
      <form id="loginForm">
        <div class="row">
          <div>
            <label>Username</label>
            <input type="text" id="loginUser" autocomplete="username" required />
          </div>
          <div style="margin-top:10px">
            <label>Password</label>
            <input type="password" id="loginPass" autocomplete="current-password" required />
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn icon" type="submit">🔓 Login</button>
          </div>
        </div>
        <div class="error" id="loginError"></div>
      </form>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar no-print">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span> Expense & Voucher Manager</div>
      <div class="nav-links">
        <a href="#" data-nav="home" class="active">Home</a>
        <a href="#" data-nav="voucher">Voucher</a>
        <a href="#" data-nav="expenses">Expenses</a>
        <a href="#" data-nav="admin" id="adminNav">Admin</a>
        <a href="#" data-nav="about">About</a>
      </div>
      <div class="userbox">
        <span class="badge" id="userBadge">Guest</span>
        <button class="btn ghost small" id="logoutBtn" title="Logout" style="display:none">⎋ Logout</button>
      </div>
    </div>
  </nav>

  <main class="container">

    <!-- HOME -->
    <section id="home" class="active">
      <div class="row cols-3">
        <div class="card">
          <div class="label">Total Voucher Count</div>
          <div class="value" id="totalVoucherCount">0</div>
          <div class="chip">📄 Vouchers</div>
        </div>
        <div class="card">
          <div class="label">Total Voucher Amount</div>
          <div class="value" id="totalVoucherAmount">₹0</div>
          <div class="chip">💰 Amount</div>
        </div>
        <div class="card">
          <div class="label">Advance vs Expenses</div>
          <div class="value"><span id="totalAdvanceAmount">₹0</span> / <span id="totalExpensesAmount">₹0</span></div>
          <div class="chip">Balance: <strong id="totalBalance">₹0</strong></div>
        </div>
      </div>

      <div class="row cols-2" style="margin-top:16px">
        <div class="panel">
          <h3>Summary Pie</h3>
          <canvas id="summaryChart" height="140"></canvas>
        </div>
        <div class="panel">
          <h3>Quick Shortcuts</h3>
          <div class="row cols-2">
            <button class="btn icon" onclick="App.navigate('voucher')">🧾 Voucher Form</button>
            <button class="btn icon" onclick="App.navigate('expenses'); App.showExpensesTab('advance')">💸 Advance</button>
            <button class="btn icon" onclick="App.navigate('expenses'); App.showExpensesTab('expenses')">🧰 Expenses</button>
            <button class="btn icon" onclick="App.navigate('expenses'); App.showExpensesTab('breakup')">🧩 Breakup</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VOUCHER -->
    <section id="voucher">
      <div class="panel">
        <h3>Voucher Form</h3>
        <form id="voucherForm">
          <div class="grid">
            <div class="col-3">
              <label>Voucher No.</label>
              <div style="display:flex;gap:8px;align-items:center">
                <input type="text" id="vNo" placeholder="Auto" />
                <label class="chip" style="cursor:pointer">
                  <input type="checkbox" id="vAuto" checked /> Auto
                </label>
              </div>
            </div>
            <div class="col-3">
              <label>Date</label>
              <input type="date" id="vDate" required />
            </div>
            <div class="col-6">
              <label>Paid To / Ms</label>
              <input type="text" id="vPaidTo" required placeholder="Name" />
            </div>
            <div class="col-6">
              <label>Purpose (By Cash / Against)</label>
              <input type="text" id="vPurpose" placeholder="By Cash / Against ..." />
            </div>
            <div class="col-3">
              <label>Amount (Rs)</label>
              <input type="number" id="vAmount" min="0" step="0.01" required />
            </div>
            <div class="col-9">
              <label>Amount in Words</label>
              <input type="text" id="vWords" readonly />
            </div>
            <div class="col-12 toolbar">
              <button class="btn icon" type="submit" id="vAddBtn">➕ Add Voucher</button>
              <button class="btn icon success" type="button" id="vUpdateBtn" disabled>✏️ Update Voucher</button>
              <button class="btn icon danger" type="button" id="vDeleteBtn" disabled>❌ Delete Voucher</button>
              <button class="btn icon secondary" type="button" id="vPrintBtn" disabled>🖨️ Print Voucher</button>
              <button class="btn icon warn" type="button" id="vExportBtn">📤 Export (.xlsx)</button>
            </div>
          </div>
        </form>

        <div class="table-wrap">
          <div class="table-tools">
            <input class="search" id="voucherSearch" placeholder="Search vouchers..." />
            <span class="chip">Click a row to select</span>
          </div>
          <table id="voucherTable">
            <thead>
              <tr>
                <th data-key="vno">Voucher No</th>
                <th data-key="date">Date</th>
                <th data-key="paidto">Paid To</th>
                <th data-key="purpose">Purpose</th>
                <th data-key="amount" data-type="number">Amount (₹)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="expenses">
      <div class="panel">
        <h3>Expenses</h3>
        <div class="tabs">
          <div class="tab active" data-exp-tab="advance" onclick="App.showExpensesTab('advance')">Advance</div>
          <div class="tab" data-exp-tab="expenses" onclick="App.showExpensesTab('expenses')">Expenses</div>
          <div class="tab" data-exp-tab="breakup" onclick="App.showExpensesTab('breakup')">Breakup</div>
        </div>

        <!-- Advance Tab -->
        <div data-exp-content="advance">
          <form id="advanceForm">
            <div class="grid">
              <div class="col-3">
                <label>Date</label>
                <input type="date" id="aDate" required />
              </div>
              <div class="col-3">
                <label>Month</label>
                <input type="text" id="aMonth" readonly />
              </div>
              <div class="col-3">
                <label>Amount</label>
                <input type="number" id="aAmount" min="0" step="0.01" required />
              </div>
              <div class="col-12">
                <label>Remarks</label>
                <input type="text" id="aRemarks" placeholder="Optional remarks" />
              </div>
              <div class="col-12 toolbar">
                <button class="btn icon" type="submit" id="aAddBtn">➕ Add</button>
                <button class="btn icon success" type="button" id="aUpdateBtn" disabled>✏️ Update</button>
                <button class="btn icon danger" type="button" id="aDeleteBtn" disabled>❌ Delete</button>
                <button class="btn icon secondary" type="button" id="aPrintBtn">🖨️ Print Report</button>
              </div>
            </div>
          </form>
          <div class="table-wrap">
            <div class="table-tools">
              <input class="search" id="advanceSearch" placeholder="Search advances..." />
              <span class="chip">Click a row to select</span>
            </div>
            <table id="advanceTable">
              <thead>
              <tr>
                <th data-key="date">Date</th>
                <th data-key="month">Month</th>
                <th data-key="amount" data-type="number">Amount (₹)</th>
                <th data-key="remarks">Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Expenses Tab -->
        <div data-exp-content="expenses" style="display:none">
          <form id="expenseForm">
            <div class="grid">
              <div class="col-2">
                <label>Sr. No.</label>
                <input type="text" id="eSr" readonly />
              </div>
              <div class="col-3">
                <label>Date</label>
                <input type="date" id="eDate" required />
              </div>
              <div class="col-3">
                <label>Expense Type</label>
                <select id="eType" required></select>
              </div>
              <div class="col-4">
                <label>Description</label>
                <input list="descList" id="eDesc" placeholder="Select or type..." />
                <datalist id="descList"></datalist>
              </div>
              <div class="col-3">
                <label>Amount</label>
                <input type="number" id="eAmount" min="0" step="0.01" required />
              </div>
              <div class="col-3">
                <label>Bill No.</label>
                <input type="text" id="eBillNo" placeholder="Bill/Ref no." />
              </div>
              <div class="col-6">
                <label>Remarks</label>
                <input type="text" id="eRemarks" placeholder="Optional" />
              </div>
              <div class="col-12 toolbar">
                <button class="btn icon" type="submit" id="eAddBtn">➕ Add</button>
                <button class="btn icon success" type="button" id="eUpdateBtn" disabled>✏️ Update</button>
                <button class="btn icon danger" type="button" id="eDeleteBtn" disabled>❌ Delete</button>
                <button class="btn icon secondary" type="button" id="ePrintBtn">🖨️ Print Report</button>
              </div>
            </div>
          </form>
          <div class="table-wrap">
            <div class="table-tools">
              <input class="search" id="expenseSearch" placeholder="Search expenses..." />
              <span class="chip">Click a row to select</span>
            </div>
            <table id="expenseTable">
              <thead>
              <tr>
                <th data-key="sr" data-type="number">Sr</th>
                <th data-key="date">Date</th>
                <th data-key="type">Type</th>
                <th data-key="desc">Description</th>
                <th data-key="amount" data-type="number">Amount (₹)</th>
                <th data-key="billno">Bill No.</th>
                <th data-key="remarks">Remarks</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Breakup Tab -->
        <div data-exp-content="breakup" style="display:none">
          <form id="breakupForm">
            <div class="grid">
              <div class="col-4">
                <label>Expense Type (new or select)</label>
                <input list="typeList" id="bType" placeholder="e.g., Travel, Food..." />
                <datalist id="typeList"></datalist>
              </div>
              <div class="col-6">
                <label>Description</label>
                <input type="text" id="bDesc" placeholder="e.g., Taxi, Lunch, Parking..." />
              </div>
              <div class="col-12 toolbar">
                <button class="btn icon" type="submit" id="bAddBtn">➕ Add</button>
                <button class="btn icon success" type="button" id="bUpdateBtn" disabled>✏️ Update</button>
                <button class="btn icon danger" type="button" id="bDeleteBtn" disabled>❌ Delete</button>
              </div>
            </div>
          </form>
          <div class="table-wrap">
            <div class="table-tools">
              <input class="search" id="breakupSearch" placeholder="Search breakup items..." />
              <span class="chip">Click a row to select</span>
            </div>
            <table id="breakupTable">
              <thead>
              <tr>
                <th data-key="type">Type</th>
                <th data-key="desc">Description</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin">
      <div class="panel">
        <h3>Admin Panel</h3>
        <p class="hint">Manage application users. Only Admins can access this page.</p>
        <form id="userForm">
          <div class="grid">
            <div class="col-3">
              <label>Username</label>
              <input type="text" id="uUsername" required />
            </div>
            <div class="col-3">
              <label>Password</label>
              <input type="password" id="uPassword" required />
            </div>
            <div class="col-3">
              <label>Confirm Password</label>
              <input type="password" id="uConfirm" required />
            </div>
            <div class="col-3">
              <label>Role</label>
              <select id="uRole">
                <option>Admin</option>
                <option>User</option>
              </select>
            </div>
            <div class="col-12 toolbar">
              <button class="btn icon" type="submit" id="uSaveBtn">💾 Save</button>
              <button class="btn icon success" type="button" id="uUpdateBtn" disabled>✏️ Update</button>
              <button class="btn icon danger" type="button" id="uDeleteBtn" disabled>❌ Delete</button>
            </div>
          </div>
        </form>

        <div class="table-wrap">
          <div class="table-tools">
            <input class="search" id="userSearch" placeholder="Search users..." />
            <span class="chip">Click a row to select</span>
          </div>
          <table id="userTable">
            <thead>
            <tr>
              <th data-key="username">Username</th>
              <th data-key="role">Role</th>
            </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </section>

    <!-- ABOUT -->
    <section id="about">
      <div class="panel">
        <h3>About</h3>
        <p>
          This lightweight web app helps track vouchers, advances, and expenses without a backend.
          It uses modern CSS, vanilla JavaScript, and popular client-side libraries for charts and export.
        </p>
        <ul>
          <li>Version: 1.0.2 (Performance)</li>
          <li>Optimized: No blur, reduced animations, deferred libs</li>
        </ul>
        <p class="hint">Authentication is client-side only; do not rely on it for production security.</p>
      </div>
    </section>

    <!-- PRINT AREA -->
    <div id="print-area"></div>

  </main>

  <script>
    const App = (() => {
      const LS_KEY = 'expenseAppData.clean.v1';
      const SS_USER = 'expenseAppUser.clean.v1';
      const state = {
        vouchers: [], advances: [], expenses: [],
        breakup: { map: {} }, users: [], srCounter: 1,
        currentUser: null
      };

      const fmtMoney = (n) => '₹' + (Number(n||0)).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      const toISO = (d) => d ? new Date(d).toISOString().slice(0,10) : '';
      const uid = () => (crypto?.randomUUID?.() || ('id-' + Date.now() + '-' + Math.random().toString(16).slice(2)));
      const monthFromDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleString('en-IN', {month:'long', year:'numeric'}) : '';
      const todayISO = () => toISO(new Date());

      function numberToWordsIndian(n){
        n = Number(n); if(isNaN(n)) return '';
        if(n === 0) return 'Zero Rupees Only';
        const ones = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
        const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
        const two = x => x<20? ones[x] : tens[Math.floor(x/10)] + (x%10? ' ' + ones[x%10] : '');
        const three = x => (Math.floor(x/100)? ones[Math.floor(x/100)]+' Hundred' + (x%100?' ':''):'') + two(x%100);
        const r = Math.floor(n), p = Math.round((n-r)*100);
        const c = Math.floor(r/1e7), l = Math.floor((r/1e5)%100), t = Math.floor((r/1e3)%100), h = r%1000;
        let s=''; if(c) s+=three(c)+' Crore '; if(l) s+=three(l)+' Lakh '; if(t) s+=three(t)+' Thousand '; if(h) s+=three(h);
        s = s.trim() + ' Rupees'; if(p) s += ' and ' + two(p) + ' Paise'; return s + ' Only';
      }

      function save(){
        const data = { vouchers:state.vouchers, advances:state.advances, expenses:state.expenses, breakup:state.breakup, users:state.users, srCounter:state.srCounter };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }
      function load(){
        try { localStorage.removeItem('expenseAppData.v1'); sessionStorage.removeItem('expenseAppUser.v1'); } catch(e){}
        const initial = { users:[{id:uid(), username:'Abhay', password:'Abhay@123', role:'Admin'}], vouchers:[], advances:[], expenses:[], breakup:{map:{}}, srCounter:1 };
        let data; try{ data = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); }catch(e){}
        data = data || initial;
        state.vouchers = data.vouchers || [];
        state.advances = data.advances || [];
        state.expenses = data.expenses || [];
        state.breakup = data.breakup || {map:{}};
        state.users = data.users && data.users.length ? data.users : initial.users;
        state.srCounter = data.srCounter || 1;
        const savedUser = sessionStorage.getItem(SS_USER); if(savedUser){ state.currentUser = JSON.parse(savedUser); }
      }

      function navigate(id){
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-links a').forEach(a => a.classList.toggle('active', a.dataset.nav === id));
        window.scrollTo({top:0, behavior:'instant'});
      }

      let chart;
      function updateDashboard(){
        const vCount = state.vouchers.length;
        const vTotal = state.vouchers.reduce((s,v)=>s+Number(v.amount||0),0);
        const aTotal = state.advances.reduce((s,a)=>s+Number(a.amount||0),0);
        const eTotal = state.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
        const balance = aTotal - eTotal;

        document.getElementById('totalVoucherCount').textContent = vCount;
        document.getElementById('totalVoucherAmount').textContent = fmtMoney(vTotal);
        document.getElementById('totalAdvanceAmount').textContent = fmtMoney(aTotal);
        document.getElementById('totalExpensesAmount').textContent = fmtMoney(eTotal);
        document.getElementById('totalBalance').textContent = fmtMoney(balance);

        const data = [Math.max(vTotal,0), Math.max(aTotal,0), Math.max(eTotal,0), Math.max(balance,0)];
        const ctx = document.getElementById('summaryChart').getContext('2d');
        if(!window.Chart){ return; } // Chart lib not ready yet
        if(!chart){
          chart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: ['Vouchers','Advance','Expenses','Balance'], datasets: [{ data, backgroundColor: ['#818cf8','#10b981','#f59e0b','#22d3ee']}] },
            options: { animation:false, responsive:true, plugins:{legend:{labels:{color:'#e5e7eb'}}}, maintainAspectRatio:false }
          });
        }else{
          chart.options.animation = false;
          chart.data.datasets[0].data = data;
          chart.update();
        }
      }

      function attachTableInteractions({tableId, searchId, onRowClick}){
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        const search = document.getElementById(searchId);
        let sortKey = null, sortDir = 1;

        function filterRows(){
          const q = (search?.value || '').trim().toLowerCase();
          for (const tr of tbody.rows) {
            tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
          }
        }
        function sortBy(th){
          const idx = [...th.parentElement.children].indexOf(th);
          const type = th.dataset.type || 'string';
          sortDir = (sortKey === idx) ? -sortDir : 1; sortKey = idx;
          const rows = [...tbody.rows].filter(r => r.style.display !== 'none');
          rows.sort((a,b)=>{
            let x = a.cells[idx].dataset.sort ?? a.cells[idx].textContent.trim();
            let y = b.cells[idx].dataset.sort ?? b.cells[idx].textContent.trim();
            if(type==='number'){ x = Number(x.replace(/[^\d.-]/g,'')); y = Number(y.replace(/[^\d.-]/g,'')); }
            return x>y? sortDir : x<y? -sortDir : 0;
          });
          rows.forEach(r => tbody.appendChild(r));
          table.querySelectorAll('thead th').forEach(h => h.textContent=h.textContent.replace(/[▲▼]/g,'')); 
          th.textContent = th.textContent + (sortDir===1? ' ▲':' ▼');
        }
        search?.addEventListener('input', filterRows, {passive:true});
        table.querySelectorAll('thead th').forEach(th => th.addEventListener('click', () => sortBy(th)));
        tbody.addEventListener('click', (e)=>{
          const tr = e.target.closest('tr'); if(!tr) return;
          [...tbody.rows].forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
          onRowClick?.(tr.dataset.id);
        });
        return { filter: filterRows, clearSelection: ()=>{[...tbody.rows].forEach(r=>r.classList.remove('selected'))} };
      }

      let voucherSelection=null, advanceSelection=null, expenseSelection=null, breakupSelection=null, userSelection=null;

      function renderVoucherTable(){
        const tbody = document.querySelector('#voucherTable tbody');
        tbody.innerHTML = state.vouchers.map(v => `
          <tr data-id="${v.id}">
            <td>${v.vno}</td>
            <td data-sort="${v.date}">${v.date}</td>
            <td>${escapeHTML(v.paidTo)}</td>
            <td>${escapeHTML(v.purpose || '')}</td>
            <td data-sort="${v.amount}">${fmtMoney(v.amount)}</td>
          </tr>
        `).join('') || `<tr><td colspan="5" style="text-align:center;color:var(--muted)">No vouchers yet.</td></tr>`;
        voucherTableCtl?.filter?.();
      }
      function fillVoucherForm(v){
        document.getElementById('vNo').value = v.vno || '';
        document.getElementById('vDate').value = v.date || todayISO();
        document.getElementById('vPaidTo').value = v.paidTo || '';
        document.getElementById('vPurpose').value = v.purpose || '';
        document.getElementById('vAmount').value = v.amount || '';
        document.getElementById('vWords').value = v.amount ? numberToWordsIndian(v.amount) : '';
      }
      function resetVoucherForm(){
        voucherSelection = null;
        document.getElementById('voucherForm').reset();
        document.getElementById('vDate').value = todayISO();
        document.getElementById('vWords').value='';
        document.getElementById('vUpdateBtn').disabled = true;
        document.getElementById('vDeleteBtn').disabled = true;
        document.getElementById('vPrintBtn').disabled = true;
        document.getElementById('vAddBtn').disabled = false;
        document.getElementById('vAuto').checked = true;
        document.getElementById('vNo').disabled = true;
        document.getElementById('vNo').placeholder = 'Auto';
        autoFillVoucherNo();
        voucherTableCtl?.clearSelection?.();
      }
      function autoFillVoucherNo(){
        if(!document.getElementById('vAuto').checked) return;
        const today = new Date();
        const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
        const prefix = `V-${y}${m}${d}-`;
        const todays = state.vouchers.filter(v => v.vno && v.vno.startsWith(prefix));
        const next = String(todays.length + 1).padStart(3,'0');
        document.getElementById('vNo').value = prefix + next;
      }
      function printVoucher(v){
        const el = document.getElementById('print-area');
        el.innerHTML = `
          <div class="voucher-print">
            <h2>Payment Voucher</h2>
            <div class="voucher-grid">
              <div><strong>Voucher No:</strong> ${v.vno}</div>
              <div><strong>Date:</strong> ${v.date}</div>
              <div><strong>Paid To / Ms:</strong> ${escapeHTML(v.paidTo)}</div>
              <div><strong>Purpose:</strong> ${escapeHTML(v.purpose || '')}</div>
              <div><strong>Amount:</strong> ${fmtMoney(v.amount)}</div>
              <div><strong>Amount in Words:</strong> ${numberToWordsIndian(v.amount)}</div>
            </div>
            <div style="margin-top:24px;display:flex;justify-content:space-between">
              <div>Prepared By: ____________</div>
              <div>Approved By: ____________</div>
              <div>Received By: ____________</div>
            </div>
          </div>
        `;
        setTimeout(()=>window.print(), 30);
      }
      async function ensureXLSX(){
        if(!window.XLSX){
          await new Promise((res, rej)=>{
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s);
          });
        }
      }
      async function exportVouchers(){
        await ensureXLSX();
        const rows = state.vouchers.map(v => ({
          'Voucher No': v.vno,'Date': v.date,'Paid To': v.paidTo,'Purpose': v.purpose || '','Amount': Number(v.amount || 0),'Amount in Words': numberToWordsIndian(v.amount)
        }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Vouchers'); XLSX.writeFile(wb, 'vouchers.xlsx');
      }

      function renderAdvanceTable(){
        const tbody = document.querySelector('#advanceTable tbody');
        tbody.innerHTML = state.advances.map(a => `
          <tr data-id="${a.id}">
            <td data-sort="${a.date}">${a.date}</td>
            <td>${escapeHTML(a.month)}</td>
            <td data-sort="${a.amount}">${fmtMoney(a.amount)}</td>
            <td>${escapeHTML(a.remarks || '')}</td>
          </tr>
        `).join('') || `<tr><td colspan="4" style="text-align:center;color:var(--muted)">No advances yet.</td></tr>`;
        advanceTableCtl?.filter?.();
      }
      function resetAdvanceForm(){
        advanceSelection = null;
        document.getElementById('advanceForm').reset();
        document.getElementById('aDate').value = todayISO();
        document.getElementById('aMonth').value = monthFromDate(todayISO());
        document.getElementById('aUpdateBtn').disabled = true;
        document.getElementById('aDeleteBtn').disabled = true;
        document.getElementById('aAddBtn').disabled = false;
        advanceTableCtl?.clearSelection?.();
      }
      function printAdvanceReport(){
        const el = document.getElementById('print-area');
        const rows = state.advances.map(a=>`<tr><td>${a.date}</td><td>${a.month}</td><td>${fmtMoney(a.amount)}</td><td>${escapeHTML(a.remarks||'')}</td></tr>`).join('');
        el.innerHTML = `
          <div style="max-width:900px;margin:0 auto">
            <h2>Advance Report</h2>
            <table border="1" cellspacing="0" cellpadding="6" style="width:100%;border-collapse:collapse">
              <thead><tr><th>Date</th><th>Month</th><th>Amount</th><th>Remarks</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        setTimeout(()=>window.print(), 30);
      }

      function renderExpenseTypeOptions(){
        const sel = document.getElementById('eType');
        const typeList = Object.keys(state.breakup.map).sort();
        sel.innerHTML = `<option value="" disabled ${typeList.length? '' : 'selected'}>Select type</option>` + typeList.map(t=>`<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');
        const dl = document.getElementById('typeList');
        dl.innerHTML = typeList.map(t=>`<option value="${escapeHTML(t)}"></option>`).join('');
      }
      function renderDescDatalist(){
        const type = document.getElementById('eType').value;
        const list = (state.breakup.map[type] || []);
        const dl = document.getElementById('descList');
        dl.innerHTML = list.map(d=>`<option value="${escapeHTML(d)}"></option>`).join('');
      }
      function renderBreakupTable(){
        const tbody = document.querySelector('#breakupTable tbody');
        const arr = [];
        for(const [type, descs] of Object.entries(state.breakup.map)){
          if(!descs.length) arr.push({id:uid(), type, desc:''});
          else descs.forEach(d => arr.push({id: type + '::' + d, type, desc:d}));
        }
        tbody.innerHTML = arr.map(b => `
          <tr data-id="${escapeHTML(b.id)}" data-type="${escapeHTML(b.type)}" data-desc="${escapeHTML(b.desc)}">
            <td>${escapeHTML(b.type)}</td>
            <td>${escapeHTML(b.desc)}</td>
          </tr>
        `).join('') || `<tr><td colspan="2" style="text-align:center;color:var(--muted)">No breakup items yet.</td></tr>`;
        breakupTableCtl?.filter?.();
      }
      function renderExpenseTable(){
        const tbody = document.querySelector('#expenseTable tbody');
        tbody.innerHTML = state.expenses.map(e => `
          <tr data-id="${e.id}">
            <td data-sort="${e.sr}">${e.sr}</td>
            <td data-sort="${e.date}">${e.date}</td>
            <td>${escapeHTML(e.type)}</td>
            <td>${escapeHTML(e.desc || '')}</td>
            <td data-sort="${e.amount}">${fmtMoney(e.amount)}</td>
            <td>${escapeHTML(e.billno || '')}</td>
            <td>${escapeHTML(e.remarks || '')}</td>
          </tr>
        `).join('') || `<tr><td colspan="7" style="text-align:center;color:var(--muted)">No expenses yet.</td></tr>`;
        expenseTableCtl?.filter?.();
      }
      function resetExpenseForm(){
        expenseSelection = null;
        document.getElementById('expenseForm').reset();
        document.getElementById('eSr').value = state.srCounter;
        document.getElementById('eDate').value = todayISO();
        document.getElementById('eUpdateBtn').disabled = true;
        document.getElementById('eDeleteBtn').disabled = true;
        document.getElementById('eAddBtn').disabled = false;
        expenseTableCtl?.clearSelection?.();
      }
      function printExpenseReport(){
        const el = document.getElementById('print-area');
        const rows = state.expenses.map(e=>`<tr>
          <td>${e.sr}</td><td>${e.date}</td><td>${escapeHTML(e.type)}</td><td>${escapeHTML(e.desc||'')}</td><td>${fmtMoney(e.amount)}</td><td>${escapeHTML(e.billno||'')}</td><td>${escapeHTML(e.remarks||'')}</td>
        </tr>`).join('');
        el.innerHTML = `
          <div style="max-width:1000px;margin:0 auto">
            <h2>Expense Report</h2>
            <table border="1" cellspacing="0" cellpadding="6" style="width:100%;border-collapse:collapse">
              <thead><tr><th>Sr</th><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>Bill No.</th><th>Remarks</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        setTimeout(()=>window.print(), 30);
      }

      function addOrUpdateBreakup({type, desc}, opts={}){
        type = (type || '').trim();
        desc = (desc || '').trim();
        if(!type){ alert('Type is required'); return false; }
        if(!state.breakup.map[type]) state.breakup.map[type] = [];
        if(desc){
          const list = state.breakup.map[type];
          if(!list.includes(desc)) list.push(desc);
        }
        if(!opts.silent){ save(); renderExpenseTypeOptions(); renderDescDatalist(); renderBreakupTable(); }
        return true;
      }
      function removeBreakup({type, desc}){
        if(!state.breakup.map[type]) return;
        if(desc){ state.breakup.map[type] = state.breakup.map[type].filter(d => d !== desc); }
        else { delete state.breakup.map[type]; }
        save(); renderExpenseTypeOptions(); renderDescDatalist(); renderBreakupTable();
      }

      function renderUserTable(){
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = state.users.map(u => `
          <tr data-id="${u.id}">
            <td>${escapeHTML(u.username)}</td>
            <td>${escapeHTML(u.role)}</td>
          </tr>
        `).join('');
        userTableCtl?.filter?.();
      }
      function resetUserForm(){
        userSelection = null;
        document.getElementById('userForm').reset();
        document.getElementById('uUpdateBtn').disabled = true;
        document.getElementById('uDeleteBtn').disabled = true;
      }
      function ensureAdminAccess(){
        const isAdmin = state.currentUser?.role === 'Admin';
        document.getElementById('adminNav').style.display = isAdmin ? '' : 'none';
        if(!isAdmin && document.querySelector('.nav-links a.active')?.dataset.nav === 'admin'){ navigate('home'); }
      }

      function setUserUI(){
        const badge = document.getElementById('userBadge');
        if(state.currentUser){
          badge.textContent = `${state.currentUser.username} (${state.currentUser.role})`;
          badge.style.color = '#bbf7d0';
          document.getElementById('logoutBtn').style.display = '';
          document.getElementById('loginOverlay').style.display = 'none';
          ensureAdminAccess();
        }else{
          badge.textContent = 'Guest';
          document.getElementById('logoutBtn').style.display = 'none';
          document.getElementById('loginOverlay').style.display = 'flex';
        }
      }
      function login(username, password){
        const user = state.users.find(u => u.username === username && u.password === password);
        if(!user) return false;
        state.currentUser = {id: user.id, username: user.username, role: user.role};
        sessionStorage.setItem(SS_USER, JSON.stringify(state.currentUser));
        setUserUI();
        return true;
      }
      function logout(){
        state.currentUser = null;
        sessionStorage.removeItem(SS_USER);
        setUserUI();
      }
      function escapeHTML(str=''){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
      function showExpensesTab(id){
        document.querySelectorAll('[data-exp-tab]').forEach(t => t.classList.toggle('active', t.dataset.expTab===id));
        document.querySelectorAll('[data-exp-content]').forEach(c => c.style.display = c.dataset.expContent===id ? '' : 'none');
      }

      let voucherTableCtl, advanceTableCtl, expenseTableCtl, breakupTableCtl, userTableCtl;

      function init(){
        load();

        document.querySelectorAll('.nav-links a').forEach(a=>{
          a.addEventListener('click', e => { e.preventDefault(); if(!state.currentUser){ return; } navigate(a.dataset.nav); });
        });
        document.getElementById('logoutBtn').addEventListener('click', ()=>{ logout(); });

        document.getElementById('loginForm').addEventListener('submit', e=>{
          e.preventDefault();
          const u = document.getElementById('loginUser').value.trim();
          const p = document.getElementById('loginPass').value;
          const ok = login(u,p);
          document.getElementById('loginError').textContent = ok ? '' : 'Invalid credentials';
          if(ok){ updateDashboard(); }
        });
        setUserUI();

        document.getElementById('vDate').value = todayISO();
        autoFillVoucherNo();
        document.getElementById('vAuto').addEventListener('change', (e)=>{
          const on = e.target.checked;
          document.getElementById('vNo').disabled = on;
          document.getElementById('vNo').placeholder = on ? 'Auto' : 'Enter manually';
          if(on) autoFillVoucherNo();
        });
        document.getElementById('vAmount').addEventListener('input', ()=>{
          const amt = Number(document.getElementById('vAmount').value || 0);
          document.getElementById('vWords').value = amt ? numberToWordsIndian(amt) : '';
        });
        document.getElementById('voucherForm').addEventListener('submit', e=>{
          e.preventDefault();
          const v = {
            id: uid(),
            vno: (document.getElementById('vNo').value || '').trim(),
            date: document.getElementById('vDate').value || todayISO(),
            paidTo: document.getElementById('vPaidTo').value.trim(),
            purpose: document.getElementById('vPurpose').value.trim(),
            amount: Number(document.getElementById('vAmount').value || 0)
          };
          if(!v.vno) { alert('Voucher No is required'); return; }
          state.vouchers.push(v);
          save(); renderVoucherTable(); updateDashboard(); resetVoucherForm();
        });
        document.getElementById('vUpdateBtn').addEventListener('click', ()=>{
          if(!voucherSelection) return;
          const idx = state.vouchers.findIndex(x => x.id === voucherSelection);
          if(idx<0) return;
          const v = state.vouchers[idx];
          v.vno = (document.getElementById('vNo').value || '').trim();
          v.date = document.getElementById('vDate').value || todayISO();
          v.paidTo = document.getElementById('vPaidTo').value.trim();
          v.purpose = document.getElementById('vPurpose').value.trim();
          v.amount = Number(document.getElementById('vAmount').value || 0);
          save(); renderVoucherTable(); updateDashboard(); resetVoucherForm();
        });
        document.getElementById('vDeleteBtn').addEventListener('click', ()=>{
          if(!voucherSelection) return;
          if(!confirm('Delete selected voucher?')) return;
          state.vouchers = state.vouchers.filter(v => v.id !== voucherSelection);
          save(); renderVoucherTable(); updateDashboard(); resetVoucherForm();
        });
        document.getElementById('vPrintBtn').addEventListener('click', ()=>{
          if(!voucherSelection) return;
          const v = state.vouchers.find(x => x.id === voucherSelection);
          if(v) printVoucher(v);
        });
        document.getElementById('vExportBtn').addEventListener('click', exportVouchers);

        voucherTableCtl = attachTableInteractions({
          tableId: 'voucherTable', searchId: 'voucherSearch',
          onRowClick: (id) => {
            voucherSelection = id;
            const v = state.vouchers.find(x => x.id === id);
            fillVoucherForm(v || {});
            document.getElementById('vUpdateBtn').disabled = !v;
            document.getElementById('vDeleteBtn').disabled = !v;
            document.getElementById('vPrintBtn').disabled = !v;
            document.getElementById('vAddBtn').disabled = !!v;
            document.getElementById('vAuto').checked = false;
            document.getElementById('vNo').disabled = false;
          }
        });

        document.getElementById('aDate').value = todayISO();
        document.getElementById('aMonth').value = monthFromDate(todayISO());
        document.getElementById('aDate').addEventListener('change', ()=>{
          document.getElementById('aMonth').value = monthFromDate(document.getElementById('aDate').value);
        });
        document.getElementById('advanceForm').addEventListener('submit', e=>{
          e.preventDefault();
          const a = {
            id: uid(),
            date: document.getElementById('aDate').value || todayISO(),
            month: document.getElementById('aMonth').value || monthFromDate(todayISO()),
            amount: Number(document.getElementById('aAmount').value || 0),
            remarks: document.getElementById('aRemarks').value.trim()
          };
          state.advances.push(a);
          save(); renderAdvanceTable(); updateDashboard(); resetAdvanceForm();
        });
        document.getElementById('aUpdateBtn').addEventListener('click', ()=>{
          if(!advanceSelection) return;
          const idx = state.advances.findIndex(x => x.id === advanceSelection);
          if(idx<0) return;
          const a = state.advances[idx];
          a.date = document.getElementById('aDate').value || todayISO();
          a.month = document.getElementById('aMonth').value || monthFromDate(a.date);
          a.amount = Number(document.getElementById('aAmount').value || 0);
          a.remarks = document.getElementById('aRemarks').value.trim();
          save(); renderAdvanceTable(); updateDashboard(); resetAdvanceForm();
        });
        document.getElementById('aDeleteBtn').addEventListener('click', ()=>{
          if(!advanceSelection) return;
          if(!confirm('Delete selected advance?')) return;
          state.advances = state.advances.filter(a => a.id !== advanceSelection);
          save(); renderAdvanceTable(); updateDashboard(); resetAdvanceForm();
        });
        document.getElementById('aPrintBtn').addEventListener('click', printAdvanceReport);

        advanceTableCtl = attachTableInteractions({
          tableId: 'advanceTable', searchId: 'advanceSearch',
          onRowClick: (id)=>{
            advanceSelection = id;
            const a = state.advances.find(x => x.id === id);
            if(!a) return;
            document.getElementById('aDate').value = a.date;
            document.getElementById('aMonth').value = a.month;
            document.getElementById('aAmount').value = a.amount;
            document.getElementById('aRemarks').value = a.remarks || '';
            document.getElementById('aUpdateBtn').disabled = false;
            document.getElementById('aDeleteBtn').disabled = false;
            document.getElementById('aAddBtn').disabled = true;
          }
        });

        renderExpenseTypeOptions();
        renderDescDatalist();
        document.getElementById('eType').addEventListener('change', renderDescDatalist);
        resetExpenseForm();

        document.getElementById('expenseForm').addEventListener('submit', e=>{
          e.preventDefault();
          const eitem = {
            id: uid(),
            sr: state.srCounter++,
            date: document.getElementById('eDate').value || todayISO(),
            type: document.getElementById('eType').value,
            desc: document.getElementById('eDesc').value.trim(),
            amount: Number(document.getElementById('eAmount').value || 0),
            billno: document.getElementById('eBillNo').value.trim(),
            remarks: document.getElementById('eRemarks').value.trim()
          };
          if(!eitem.type){ alert('Please select Expense Type'); return; }
          state.expenses.push(eitem);
          if(eitem.desc){ addOrUpdateBreakup({type:eitem.type, desc:eitem.desc}, {silent:true}); }
          save(); renderExpenseTable(); renderBreakupTable(); renderExpenseTypeOptions(); updateDashboard(); resetExpenseForm();
        });
        document.getElementById('eUpdateBtn').addEventListener('click', ()=>{
          if(!expenseSelection) return;
          const idx = state.expenses.findIndex(x => x.id === expenseSelection);
          if(idx<0) return;
          const ei = state.expenses[idx];
          ei.date = document.getElementById('eDate').value || todayISO();
          ei.type = document.getElementById('eType').value;
          ei.desc = document.getElementById('eDesc').value.trim();
          ei.amount = Number(document.getElementById('eAmount').value || 0);
          ei.billno = document.getElementById('eBillNo').value.trim();
          ei.remarks = document.getElementById('eRemarks').value.trim();
          if(ei.desc){ addOrUpdateBreakup({type:ei.type, desc:ei.desc}, {silent:true}); }
          save(); renderExpenseTable(); renderBreakupTable(); renderExpenseTypeOptions(); updateDashboard(); resetExpenseForm();
        });
        document.getElementById('eDeleteBtn').addEventListener('click', ()=>{
          if(!expenseSelection) return;
          if(!confirm('Delete selected expense?')) return;
          state.expenses = state.expenses.filter(e => e.id !== expenseSelection);
          save(); renderExpenseTable(); updateDashboard(); resetExpenseForm();
        });
        document.getElementById('ePrintBtn').addEventListener('click', printExpenseReport);

        expenseTableCtl = attachTableInteractions({
          tableId: 'expenseTable', searchId: 'expenseSearch',
          onRowClick: (id)=>{
            expenseSelection = id;
            const eitem = state.expenses.find(x => x.id === id);
            if(!eitem) return;
            document.getElementById('eSr').value = eitem.sr;
            document.getElementById('eDate').value = eitem.date;
            document.getElementById('eType').value = eitem.type;
            renderDescDatalist();
            document.getElementById('eDesc').value = eitem.desc || '';
            document.getElementById('eAmount').value = eitem.amount;
            document.getElementById('eBillNo').value = eitem.billno || '';
            document.getElementById('eRemarks').value = eitem.remarks || '';
            document.getElementById('eUpdateBtn').disabled = false;
            document.getElementById('eDeleteBtn').disabled = false;
            document.getElementById('eAddBtn').disabled = true;
          }
        });

        document.getElementById('breakupForm').addEventListener('submit', e=>{
          e.preventDefault();
          const type = document.getElementById('bType').value;
          const desc = document.getElementById('bDesc').value;
          const ok = addOrUpdateBreakup({type, desc});
          if(ok){ document.getElementById('bType').value = ''; document.getElementById('bDesc').value = ''; }
        });
        document.getElementById('bUpdateBtn').addEventListener('click', ()=>{
          if(!breakupSelection) return;
          const old = breakupSelection;
          const newType = document.getElementById('bType').value.trim();
          const newDesc = document.getElementById('bDesc').value.trim();
          if(old.type !== newType){ removeBreakup({type: old.type, desc: old.desc}); addOrUpdateBreakup({type: newType, desc: newDesc}); }
          else{
            if(old.desc && old.desc !== newDesc){ removeBreakup({type: old.type, desc: old.desc}); addOrUpdateBreakup({type: newType, desc: newDesc}); }
            else if(!old.desc && newDesc){ addOrUpdateBreakup({type: newType, desc: newDesc}); }
            else if(!newDesc){ addOrUpdateBreakup({type: newType, desc: ''}); }
          }
          breakupSelection = null;
          document.getElementById('bUpdateBtn').disabled = true;
          document.getElementById('bDeleteBtn').disabled = true;
          document.getElementById('bType').value = '';
          document.getElementById('bDesc').value = '';
        });
        document.getElementById('bDeleteBtn').addEventListener('click', ()=>{
          if(!breakupSelection) return;
          if(!confirm('Delete this record from breakup?')) return;
          removeBreakup(breakupSelection);
          breakupSelection = null;
          document.getElementById('bUpdateBtn').disabled = true;
          document.getElementById('bDeleteBtn').disabled = true;
          document.getElementById('bType').value = '';
          document.getElementById('bDesc').value = '';
        });

        breakupTableCtl = attachTableInteractions({
          tableId: 'breakupTable', searchId: 'breakupSearch',
          onRowClick: (id)=>{
            const tr = document.querySelector(`#breakupTable tbody tr[data-id="${CSS.escape(id)}"]`);
            if(!tr) return;
            breakupSelection = {type: tr.dataset.type, desc: tr.dataset.desc};
            document.getElementById('bType').value = breakupSelection.type;
            document.getElementById('bDesc').value = breakupSelection.desc;
            document.getElementById('bUpdateBtn').disabled = false;
            document.getElementById('bDeleteBtn').disabled = false;
          }
        });

        // Initial renders (skip chart until login)
        renderVoucherTable();
        renderAdvanceTable();
        renderExpenseTable();
        renderBreakupTable();
        if(state.currentUser){ updateDashboard(); }
      }

      return { init, navigate, showExpensesTab };
    })();

    document.addEventListener('DOMContentLoaded', App.init);
  </script>
</body>
</html>
