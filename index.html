<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voucher & Expenses Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="data:," />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg: #0b1020;             /* surfaces (dark mode friendly) */
      --panel:#0f172a;
      --muted:#94a3b8;
      --border:#1e293b;
      --text:#e2e8f0;
      --brand:#3b82f6;           /* primary */
      --brand-2:#22c55e;         /* success */
      --warn:#f59e0b;            /* warning */
      --danger:#ef4444;          /* danger */
      --card: #111827;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      background: linear-gradient(180deg,#050816 0%,#0b1020 50%,#0a132a 100%);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}

    /* Navbar */
    .navbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(150%) blur(10px);
      background:linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.6));
      border-bottom:1px solid var(--border);
    }
    .navbar-inner{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:14px 20px; max-width:1200px; margin:0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
    }
    .brand-badge{
      width:34px;height:34px;border-radius:10px;background:
        conic-gradient(from 180deg at 50% 50%, #3b82f6, #22c55e, #f59e0b, #3b82f6);
      box-shadow: inset 0 0 12px rgba(255,255,255,.2), 0 6px 20px rgba(0,0,0,.35);
    }
    .nav{
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .nav a{
      padding:10px 14px;border-radius:10px;color:var(--muted);font-weight:600;
      border:1px solid transparent; transition:.2s;
    }
    .nav a:hover{color:var(--text);background:rgba(59,130,246,.08);border-color:#1e293b}
    .nav a.active{color:var(--text); background:linear-gradient(180deg,rgba(59,130,246,.22), rgba(59,130,246,.06)); border-color:#1f3b63}

    /* Layout cards */
    .grid{
      display:grid; gap:18px;
    }
    @media(min-width:768px){
      .grid.cols-3{grid-template-columns:repeat(3,1fr)}
      .grid.cols-2{grid-template-columns:repeat(2,1fr)}
      .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    }
    .card{
      background:linear-gradient(180deg, rgba(17,24,39,.7), rgba(2,6,23,.7));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .card-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px dashed #1f2937; color:#cbd5e1;
      background:linear-gradient(180deg, rgba(30,41,59,.4), rgba(2,6,23,0));
    }
    .card .card-body{padding:16px}
    .muted{color:var(--muted)}
    .spacer{height:12px}

    /* Buttons */
    .btn{
      --bg: rgba(59,130,246,.15); --b: #1f3b63; --c:#cbd5e1;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:10px; border:1px solid var(--b); background:var(--bg); color:var(--c);
      font-weight:600; transition:.2s; text-wrap:nowrap;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn.primary{--bg:linear-gradient(180deg, rgba(59,130,246,.35), rgba(59,130,246,.08)); --b:#1f3b63}
    .btn.success{--bg:linear-gradient(180deg, rgba(34,197,94,.35), rgba(34,197,94,.08)); --b:#1b4d34}
    .btn.warn{--bg:linear-gradient(180deg, rgba(245,158,11,.3), rgba(245,158,11,.08)); --b:#614015}
    .btn.danger{--bg:linear-gradient(180deg, rgba(239,68,68,.35), rgba(239,68,68,.08)); --b:#5a2323}
    .btn.ghost{--bg:transparent; --b:transparent; color:#a3b2c8}
    .btn.small{padding:6px 10px; font-size:.9rem; border-radius:8px}

    .btn-group{display:flex; gap:8px; flex-wrap:wrap}

    /* Form */
    .form-row{display:grid; gap:12px}
    @media(min-width:768px){ .form-row.cols-2{grid-template-columns:1fr 1fr} .form-row.cols-3{grid-template-columns:repeat(3,1fr)} }
    label{font-size:.9rem; color:#9fb1c8; display:block; margin-bottom:6px}
    input, select, textarea, datalist{
      width:100%; padding:11px 12px; border-radius:10px; outline:none;
      background:rgba(2,6,23,.6); border:1px solid #2a3650; color:var(--text);
      transition:.2s; box-shadow: inset 0 1px 0 rgba(255,255,255,.02);
    }
    input:focus, select:focus, textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.2)}
    input[readonly]{opacity:.8}

    /* Tables */
    .table-tools{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .search{
      display:flex; align-items:center; gap:8px; background:rgba(2,6,23,.6); border:1px solid #25324a; padding:8px 10px; border-radius:10px; color:#a8b3c7;
    }
    .search input{background:transparent; border:none; outline:none; color:#e2e8f0; padding:6px 8px}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid #1f2937; border-radius:12px}
    thead th{
      text-align:left; font-weight:700; color:#9fb1c8; background:rgba(15,23,42,.8); padding:12px; font-size:.95rem; position:relative;
      border-bottom:1px solid #1f2937; cursor:pointer; user-select:none;
    }
    thead th .sort{font-size:.8rem; color:#61708a; margin-left:6px}
    tbody td{padding:12px; border-bottom:1px dashed #23314e; color:#d6dfeb; vertical-align:top}
    tbody tr:hover{background:rgba(59,130,246,.06)}
    tbody tr.selected{background:rgba(59,130,246,.16)}
    tfoot td{padding:10px; background:rgba(2,6,23,.55); color:#9fb1c8}
    .right{text-align:right}

    /* Pages */
    .page{display:none; animation:fade .25s ease}
    .page.active{display:block}
    @keyframes fade{from{opacity:.5;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

    /* Subtabs */
    .subtabs{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    .subtab{
      padding:10px 14px; border-radius:10px; border:1px solid #2a3650; color:#9fb1c8; background:rgba(2,6,23,.5);
      cursor:pointer; font-weight:700;
    }
    .subtab.active{color:#e2e8f0; background:linear-gradient(180deg, rgba(59,130,246,.22), rgba(59,130,246,.06)); border-color:#1f3b63}
    .subpage{display:none}
    .subpage.active{display:block}

    /* Tiny badge / pill */
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #2a3650; color:#94a3b8; background:rgba(2,6,23,.5); font-weight:600}

    /* Export dropdown */
    .dropdown{position:relative; display:inline-block}
    .dropdown-menu{
      position:absolute; right:0; min-width:180px; background:rgba(2,6,23,.95); border:1px solid #2a3650; border-radius:10px; padding:6px; box-shadow:var(--shadow);
      display:none; z-index:10;
    }
    .dropdown.open .dropdown-menu{display:block}
    .dropdown-menu button{width:100%; text-align:left; margin:2px 0}

    /* Toasts */
    .toast{
      position:fixed; right:18px; bottom:18px; background:rgba(2,6,23,.95); border:1px solid #2a3650; color:#d4e0f0;
      padding:12px 14px; border-radius:10px; box-shadow:var(--shadow); z-index:1000; min-width:220px;
    }

    /* Print */
    @media print{
      body{background:white}
      .navbar, .no-print{display:none !important}
      .printable{display:block}
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-inner">
      <div class="brand">
        <div class="brand-badge"></div>
        <div>Voucher & Expenses Manager</div>
      </div>
      <nav class="nav">
        <a href="#home" data-route="home" class="active">Home</a>
        <a href="#voucher" data-route="voucher">Voucher</a>
        <a href="#expenses" data-route="expenses">Expenses</a>
        <a href="#about" data-route="about">About</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Home -->
    <section id="page-home" class="page active">
      <div class="grid">
        <div class="card">
          <div class="card-header"><span>Dashboard Summary</span><span class="pill">Live</span></div>
          <div class="card-body">
            <div class="grid cols-3">
              <div class="card" style="background:linear-gradient(180deg, rgba(59,130,246,.25), rgba(59,130,246,.05));">
                <div class="card-body">
                  <div class="muted">Total Vouchers</div>
                  <div id="d-voucher-count" style="font-size:1.6rem; font-weight:800; margin-top:6px">0</div>
                </div>
              </div>
              <div class="card" style="background:linear-gradient(180deg, rgba(34,197,94,.25), rgba(34,197,94,.05));">
                <div class="card-body">
                  <div class="muted">Total Voucher Amount</div>
                  <div id="d-voucher-amount" style="font-size:1.6rem; font-weight:800; margin-top:6px">₹0</div>
                </div>
              </div>
              <div class="card" style="background:linear-gradient(180deg, rgba(245,158,11,.25), rgba(245,158,11,.05));">
                <div class="card-body">
                  <div class="muted">Balance</div>
                  <div id="d-balance" style="font-size:1.6rem; font-weight:800; margin-top:6px">₹0</div>
                </div>
              </div>
            </div>
            <div class="spacer"></div>
            <div class="grid cols-3">
              <div class="card">
                <div class="card-body">
                  <div class="muted">Total Advances</div>
                  <div id="d-adv" style="font-size:1.4rem; font-weight:800; margin-top:6px">₹0</div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="muted">Total Expenses</div>
                  <div id="d-exp" style="font-size:1.4rem; font-weight:800; margin-top:6px">₹0</div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <canvas id="pieChart" height="140"></canvas>
                  <div class="muted" style="margin-top:8px">Expenses vs Balance (of Advances)</div>
                  <div id="deficit-note" class="pill" style="display:none; margin-top:8px; border-color:#614015; color:#f7c86a">Deficit exceeds advances</div>
                </div>
              </div>
            </div>
            <div class="spacer"></div>
            <div class="grid cols-3">
              <div class="card">
                <div class="card-body">
                  <div class="muted">Quick Actions</div>
                  <div class="spacer"></div>
                  <div class="btn-group">
                    <button class="btn primary" onclick="Router.go('voucher')">🧾 Voucher Form</button>
                    <button class="btn success" onclick="Router.go('expenses'); setSubtab('advance')">💵 Advance</button>
                    <button class="btn" onclick="Router.go('expenses'); setSubtab('expenses')">🧮 Expenses</button>
                    <button class="btn" onclick="Router.go('expenses'); setSubtab('breakup')">⚙️ Breakup</button>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="muted">Tips</div>
                  <ul style="margin:8px 0 0 18px; color:#c5d2e6">
                    <li>Click table headers to sort. Use the search box to filter.</li>
                    <li>Click a row to select for Update, Delete, or Print.</li>
                    <li>Data is saved to your browser (localStorage).</li>
                  </ul>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="muted">Version</div>
                  <div style="font-weight:700; font-size:1.1rem; margin-top:6px">v1.0.0</div>
                  <div class="muted" style="margin-top:6px">No backend required. Export to Excel, print-friendly views.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /grid -->
    </section>

    <!-- Voucher -->
    <section id="page-voucher" class="page">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <span>Voucher Form</span>
            <span class="pill">🧾 Payment / General Voucher</span>
          </div>
          <div class="card-body">
            <div class="form-row cols-3">
              <div>
                <label>Voucher No.</label>
                <input type="text" id="v-voucherNo" placeholder="Auto-generated; you can edit" />
              </div>
              <div>
                <label>Date</label>
                <input type="date" id="v-date" />
              </div>
              <div>
                <label>Paid To / Ms</label>
                <input type="text" id="v-paidTo" placeholder="Name" />
              </div>
            </div>
            <div class="form-row cols-3" style="margin-top:12px">
              <div>
                <label>Purpose (By Cash / Against)</label>
                <input type="text" id="v-purpose" placeholder="By Cash / Against ..." />
              </div>
              <div>
                <label>Amount (Rs)</label>
                <input type="number" id="v-amount" min="0" step="1" placeholder="0" />
              </div>
              <div>
                <label>Amount in Words</label>
                <input type="text" id="v-amountWords" readonly placeholder="Auto-filled" />
              </div>
            </div>
            <div class="spacer"></div>
            <div class="btn-group no-print">
              <button class="btn success" id="v-add">➕ Add Voucher</button>
              <button class="btn primary" id="v-update" disabled>✏️ Update Voucher</button>
              <button class="btn danger" id="v-delete" disabled>❌ Delete Voucher</button>
              <button class="btn" id="v-print">🖨️ Print Voucher</button>
              <div class="dropdown">
                <button class="btn" id="v-export">📊 Export</button>
                <div class="dropdown-menu">
                  <button class="btn small" id="v-export-xlsx">Export to Excel (.xlsx)</button>
                  <button class="btn small" id="v-export-csv">Export to CSV (.csv)</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Vouchers</span>
            <div class="table-tools">
              <div class="search">
                🔎
                <input id="v-search" placeholder="Search any column..." />
              </div>
              <div class="muted">Click headers to sort</div>
            </div>
          </div>
          <div class="card-body">
            <div style="overflow:auto">
              <table id="v-table">
                <thead>
                  <tr>
                    <th data-key="voucherNo">Voucher No <span class="sort">↕</span></th>
                    <th data-key="date">Date <span class="sort">↕</span></th>
                    <th data-key="paidTo">Paid To <span class="sort">↕</span></th>
                    <th data-key="purpose">Purpose <span class="sort">↕</span></th>
                    <th data-key="amount" class="right">Amount <span class="sort">↕</span></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr><td colspan="4" class="right">Total</td><td id="v-total" class="right">₹0</td></tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Expenses -->
    <section id="page-expenses" class="page">
      <div class="card">
        <div class="card-header">
          <span>Expenses Manager</span>
          <span class="pill">💼 Advances, Expenses, and Breakup</span>
        </div>
        <div class="card-body">
          <div class="subtabs no-print">
            <button class="subtab active" data-subtab="advance" onclick="setSubtab('advance')">A. Advance</button>
            <button class="subtab" data-subtab="expenses" onclick="setSubtab('expenses')">B. Expenses</button>
            <button class="subtab" data-subtab="breakup" onclick="setSubtab('breakup')">C. Breakup</button>
          </div>

          <!-- Advance -->
          <div id="subtab-advance" class="subpage active">
            <div class="form-row cols-3">
              <div>
                <label>Date</label>
                <input type="date" id="a-date" />
              </div>
              <div>
                <label>Month</label>
                <input type="text" id="a-month" readonly placeholder="Auto from date" />
              </div>
              <div>
                <label>Amount</label>
                <input type="number" id="a-amount" min="0" step="1" placeholder="0" />
              </div>
            </div>
            <div class="form-row" style="margin-top:12px">
              <div>
                <label>Remarks</label>
                <input type="text" id="a-remarks" placeholder="Remarks (optional)" />
              </div>
            </div>
            <div class="spacer"></div>
            <div class="btn-group no-print">
              <button class="btn success" id="a-add">➕ Add</button>
              <button class="btn primary" id="a-update" disabled>✏️ Update</button>
              <button class="btn danger" id="a-delete" disabled>❌ Delete</button>
              <button class="btn" id="a-print">🖨️ Print Report</button>
            </div>

            <div class="spacer"></div>
            <div class="table-tools">
              <div class="search">🔎 <input id="a-search" placeholder="Search..." /></div>
              <div class="muted">Click headers to sort</div>
            </div>
            <div style="overflow:auto">
              <table id="a-table">
                <thead>
                  <tr>
                    <th data-key="date">Date <span class="sort">↕</span></th>
                    <th data-key="month">Month <span class="sort">↕</span></th>
                    <th data-key="amount" class="right">Amount <span class="sort">↕</span></th>
                    <th data-key="remarks">Remarks <span class="sort">↕</span></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr><td colspan="2" class="right">Total</td><td id="a-total" class="right">₹0</td><td></td></tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Expenses -->
          <div id="subtab-expenses" class="subpage">
            <div class="form-row cols-3">
              <div>
                <label>Sr. No.</label>
                <input type="number" id="e-srno" readonly />
              </div>
              <div>
                <label>Date</label>
                <input type="date" id="e-date" />
              </div>
              <div>
                <label>Expense Type</label>
                <input list="type-list" id="e-type" placeholder="Select or type..." />
                <datalist id="type-list"></datalist>
              </div>
            </div>
            <div class="form-row cols-3" style="margin-top:12px">
              <div>
                <label>Description</label>
                <input list="desc-list" id="e-desc" placeholder="Pick or type..." />
                <datalist id="desc-list"></datalist>
              </div>
              <div>
                <label>Amount</label>
                <input type="number" id="e-amount" min="0" step="1" placeholder="0" />
              </div>
              <div>
                <label>Bill No.</label>
                <input type="text" id="e-bill" placeholder="Bill / Ref No." />
              </div>
            </div>
            <div class="form-row" style="margin-top:12px">
              <div>
                <label>Remarks</label>
                <input type="text" id="e-remarks" placeholder="Remarks (optional)" />
              </div>
            </div>
            <div class="spacer"></div>
            <div class="btn-group no-print">
              <button class="btn success" id="e-add">➕ Add</button>
              <button class="btn primary" id="e-update" disabled>✏️ Update</button>
              <button class="btn danger" id="e-delete" disabled>❌ Delete</button>
              <button class="btn" id="e-print">🖨️ Print Report</button>
            </div>

            <div class="spacer"></div>
            <div class="table-tools">
              <div class="search">🔎 <input id="e-search" placeholder="Search..." /></div>
              <div class="muted">Click headers to sort</div>
            </div>
            <div style="overflow:auto">
              <table id="e-table">
                <thead>
                  <tr>
                    <th data-key="srno">Sr. No <span class="sort">↕</span></th>
                    <th data-key="date">Date <span class="sort">↕</span></th>
                    <th data-key="type">Type <span class="sort">↕</span></th>
                    <th data-key="description">Description <span class="sort">↕</span></th>
                    <th data-key="amount" class="right">Amount <span class="sort">↕</span></th>
                    <th data-key="billno">Bill No. <span class="sort">↕</span></th>
                    <th data-key="remarks">Remarks <span class="sort">↕</span></th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr><td colspan="4" class="right">Total</td><td id="e-total" class="right">₹0</td><td colspan="2"></td></tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Breakup -->
          <div id="subtab-breakup" class="subpage">
            <div class="form-row cols-3">
              <div>
                <label>Expense Type (select or type new)</label>
                <input list="type-list" id="b-type" placeholder="Type e.g. Travel" />
              </div>
              <div>
                <label>Description</label>
                <input type="text" id="b-desc" placeholder="e.g. Taxi, Stationery..." />
              </div>
            </div>
            <div class="spacer"></div>
            <div class="btn-group no-print">
              <button class="btn success" id="b-add">➕ Add</button>
              <button class="btn primary" id="b-update" disabled>✏️ Update</button>
              <button class="btn danger" id="b-delete" disabled>❌ Delete</button>
            </div>

            <div class="spacer"></div>
            <div class="table-tools">
              <div class="search">🔎 <input id="b-search" placeholder="Search..." /></div>
              <div class="muted">Click headers to sort</div>
            </div>
            <div style="overflow:auto">
              <table id="b-table">
                <thead>
                  <tr>
                    <th data-key="type">Type <span class="sort">↕</span></th>
                    <th data-key="description">Description <span class="sort">↕</span></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section id="page-about" class="page">
      <div class="grid">
        <div class="card">
          <div class="card-header">About</div>
          <div class="card-body">
            <p style="color:#cbd5e1">
              This is a lightweight, responsive web app to manage Vouchers, Advances, and Expenses — no backend required.
              Data is stored in-browser, with export to Excel/CSV and print-friendly reports.
            </p>
            <div class="grid cols-3">
              <div class="card">
                <div class="card-body">
                  <div class="muted">Application</div>
                  <div style="font-weight:800; font-size:1.1rem; margin-top:6px">Voucher & Expenses Manager</div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="muted">Developer</div>
                  <div style="font-weight:800; font-size:1.1rem; margin-top:6px">Your Company</div>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="muted">Version</div>
                  <div style="font-weight:800; font-size:1.1rem; margin-top:6px">v1.0.0</div>
                </div>
              </div>
            </div>
            <div class="pill" style="margin-top:10px">Built with HTML, CSS (flex/grid), Vanilla JS, Chart.js, SheetJS</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  // ------------------------------ Data Store ------------------------------
  const STORAGE_KEY = 'voucher-expenses-db-v1';

  const DB = {
    vouchers: [],      // {id, voucherNo, date, paidTo, purpose, amount, amountWords}
    advances: [],      // {id, date, month, amount, remarks}
    expenses: [],      // {id, srno, date, type, description, amount, billno, remarks}
    breakups: [],      // {id, type, description}
    counters: { voucher: 1, expenseSr: 1, ids: 1 }
  };

  function loadDB(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        Object.assign(DB, parsed);
      } else {
        // seed some breakup options
        DB.breakups = [
          {id: DB.counters.ids++, type:'Travel', description:'Taxi'},
          {id: DB.counters.ids++, type:'Travel', description:'Train'},
          {id: DB.counters.ids++, type:'Food', description:'Breakfast'},
          {id: DB.counters.ids++, type:'Food', description:'Lunch'},
          {id: DB.counters.ids++, type:'Office Supplies', description:'Stationery'},
          {id: DB.counters.ids++, type:'Utilities', description:'Electricity'},
          {id: DB.counters.ids++, type:'Rent', description:'Office Rent'},
        ];
      }
    }catch(e){ console.error('Failed to load DB', e); }
  }
  function saveDB(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }catch(e){} }

  // ------------------------------ Router ------------------------------
  const Router = {
    current: 'home',
    go(route){
      const hash = '#' + route;
      history.pushState(null, '', hash);
      Router.render(route);
    },
    render(route){
      Router.current = route;
      document.querySelectorAll('.nav a').forEach(a=>{
        a.classList.toggle('active', a.dataset.route === route);
      });
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById('page-' + route).classList.add('active');
      if(route==='home') renderDashboard();
      if(route==='voucher') {
        ensureVoucherNo();
        renderVouchersTable();
      }
      if(route==='expenses'){
        renderBreakupDatalists();
        renderAdvancesTable();
        renderExpensesTable();
        renderBreakupTable();
      }
    }
  };
  window.addEventListener('popstate', ()=>{
    const route = location.hash.replace('#','') || 'home';
    Router.render(route);
  });

  // ------------------------------ Helpers ------------------------------
  const fmt = {
    currency(n){ try{ return n.toLocaleString('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:0 }); } catch{ return '₹'+Number(n||0).toFixed(0); } },
    dateISO(d){ return d ? new Date(d).toISOString().slice(0,10) : ''; },
    dateDisplay(d){
      if(!d) return '';
      const dt = new Date(d+'T00:00:00');
      return dt.toLocaleDateString('en-GB',{ day:'2-digit', month:'short', year:'numeric' });
    },
    monthFromDate(d){
      if(!d) return '';
      const dt = new Date(d+'T00:00:00');
      return dt.toLocaleString('en-GB',{ month:'long', year:'numeric' });
    }
  };

  function showToast(msg, timeout=2200){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.display='none'; }, timeout);
  }

  // Indian number to words (Rupees)
  function numberToWordsIndian(num){
    num = Math.floor(Number(num)||0);
    if(num === 0) return 'Zero Rupees only';
    const ones = ['', 'One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const tens = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    const two = (n)=> n<20 ? ones[n] : (tens[Math.floor(n/10)] + (n%10? ' ' + ones[n%10] : ''));
    const three = (n)=> {
      let s=''; if(n>=100){ s += ones[Math.floor(n/100)] + ' Hundred'; n = n%100; if(n) s+=' '; }
      if(n) s += two(n); return s;
    };
    let s='';
    const crore = Math.floor(num/10000000); num%=10000000;
    const lakh = Math.floor(num/100000); num%=100000;
    const thousand = Math.floor(num/1000); num%=1000;
    const hundred = num;
    if(crore) s += three(crore) + ' Crore ';
    if(lakh) s += three(lakh) + ' Lakh ';
    if(thousand) s += three(thousand) + ' Thousand ';
    if(hundred) s += three(hundred);
    return s.trim() + ' Rupees only';
  }

  function nextId(){ return DB.counters.ids++; }
  function nextVoucherNo(){ return 'V-' + String(DB.counters.voucher++).padStart(4,'0'); }
  function nextExpenseSr(){ return DB.counters.expenseSr++; }

  // ------------------------------ Voucher ------------------------------
  let voucherSort = { key:'date', dir:'desc' };
  let voucherSearch = '';
  let selectedVoucherId = null;
  const vEls = {
    voucherNo: ()=>document.getElementById('v-voucherNo'),
    date: ()=>document.getElementById('v-date'),
    paidTo: ()=>document.getElementById('v-paidTo'),
    purpose: ()=>document.getElementById('v-purpose'),
    amount: ()=>document.getElementById('v-amount'),
    amountWords: ()=>document.getElementById('v-amountWords'),
    table: ()=>document.getElementById('v-table').querySelector('tbody'),
    total: ()=>document.getElementById('v-total'),
    search: ()=>document.getElementById('v-search'),
    btnAdd: ()=>document.getElementById('v-add'),
    btnUpdate: ()=>document.getElementById('v-update'),
    btnDelete: ()=>document.getElementById('v-delete'),
    btnPrint: ()=>document.getElementById('v-print'),
    exportBtn: ()=>document.getElementById('v-export')
  };

  function ensureVoucherNo(){
    if(!vEls.voucherNo().value){
      vEls.voucherNo().value = nextVoucherNo();
    }
  }

  function readVoucherForm(){
    const amount = Number(vEls.amount().value||0);
    return {
      voucherNo: vEls.voucherNo().value.trim() || nextVoucherNo(),
      date: vEls.date().value || fmt.dateISO(new Date()),
      paidTo: vEls.paidTo().value.trim(),
      purpose: vEls.purpose().value.trim(),
      amount: amount
    };
  }

  function setVoucherForm(data){
    vEls.voucherNo().value = data.voucherNo || '';
    vEls.date().value = data.date || '';
    vEls.paidTo().value = data.paidTo || '';
    vEls.purpose().value = data.purpose || '';
    vEls.amount().value = data.amount ?? '';
    vEls.amountWords().value = numberToWordsIndian(data.amount||0);
  }

  function clearVoucherForm(){
    setVoucherForm({ voucherNo: nextVoucherNo(), date: fmt.dateISO(new Date()), paidTo:'', purpose:'', amount:'' });
    selectedVoucherId = null;
    vEls.btnUpdate().disabled = true;
    vEls.btnDelete().disabled = true;
  }

  function addVoucher(){
    const f = readVoucherForm();
    if(!f.paidTo || !f.purpose || !(f.amount>0)){
      showToast('Please fill Paid To, Purpose, and a valid Amount.');
      return;
    }
    const rec = { id: nextId(), ...f, amountWords:numberToWordsIndian(f.amount) };
    DB.vouchers.push(rec);
    saveDB();
    renderVouchersTable();
    renderDashboard();
    showToast('Voucher added.');
    clearVoucherForm();
  }

  function updateVoucher(){
    if(!selectedVoucherId){ showToast('Select a voucher row to update.'); return; }
    const f = readVoucherForm();
    const idx = DB.vouchers.findIndex(v=>v.id===selectedVoucherId);
    if(idx>=0){
      DB.vouchers[idx] = { ...DB.vouchers[idx], ...f, amountWords:numberToWordsIndian(f.amount) };
      saveDB();
      renderVouchersTable();
      renderDashboard();
      showToast('Voucher updated.');
    }
  }

  function deleteVoucher(){
    if(!selectedVoucherId){ showToast('Select a voucher row to delete.'); return; }
    if(!confirm('Delete selected voucher?')) return;
    DB.vouchers = DB.vouchers.filter(v=>v.id!==selectedVoucherId);
    saveDB();
    renderVouchersTable();
    renderDashboard();
    showToast('Voucher deleted.');
    clearVoucherForm();
  }

  function renderVouchersTable(){
    const tbody = vEls.table();
    let rows = DB.vouchers.slice();

    // search
    const q = voucherSearch.trim().toLowerCase();
    if(q){
      rows = rows.filter(r => Object.values(r).some(val => (''+val).toLowerCase().includes(q)));
    }
    // sort
    rows.sort((a,b)=>{
      const k = voucherSort.key;
      let va = a[k], vb = b[k];
      if(k==='amount'){ va = Number(va||0); vb = Number(vb||0); }
      if(k==='date'){ va = va || ''; vb = vb || ''; }
      if(va<vb) return voucherSort.dir==='asc'?-1:1;
      if(va>vb) return voucherSort.dir==='asc'?1:-1;
      return 0;
    });

    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id}">
        <td>${escapeHtml(r.voucherNo||'')}</td>
        <td>${fmt.dateDisplay(r.date)}</td>
        <td>${escapeHtml(r.paidTo||'')}</td>
        <td>${escapeHtml(r.purpose||'')}</td>
        <td class="right">${fmt.currency(r.amount||0)}</td>
      </tr>
    `).join('');

    // selection
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        tbody.querySelectorAll('tr').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        selectedVoucherId = Number(tr.getAttribute('data-id'));
        const rec = DB.vouchers.find(x=>x.id===selectedVoucherId);
        setVoucherForm(rec);
        vEls.btnUpdate().disabled = false;
        vEls.btnDelete().disabled = false;
      });
    });

    // total
    const tot = rows.reduce((s,r)=>s+Number(r.amount||0),0);
    vEls.total().textContent = fmt.currency(tot);

    // bind header sort
    document.querySelectorAll('#v-table thead th').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-key');
        if(k){
          if(voucherSort.key===k) voucherSort.dir = voucherSort.dir==='asc'?'desc':'asc';
          else { voucherSort.key = k; voucherSort.dir='asc'; }
          renderVouchersTable();
        }
      };
    });

    // amount words live
    vEls.amount().oninput = ()=>{
      const amt = Number(vEls.amount().value||0);
      vEls.amountWords().value = numberToWordsIndian(amt);
    };
  }

  function printVoucher(){
    // Use selected or current form
    let rec = null;
    if(selectedVoucherId) rec = DB.vouchers.find(v=>v.id===selectedVoucherId);
    if(!rec){
      const f = readVoucherForm();
      if(!(f.amount>0) || !f.paidTo) { showToast('Select a voucher or fill form to print.'); return; }
      rec = { ...f, amountWords:numberToWordsIndian(f.amount) };
    }
    const html = `
      <html><head>
        <title>Voucher ${escapeHtml(rec.voucherNo||'')}</title>
        <style>
          body{font-family:Inter,Arial; padding:24px; color:#111}
          .voucher{max-width:780px; margin:0 auto; border:1px solid #999; padding:20px; border-radius:10px}
          h2{margin:0 0 12px 0}
          .row{display:flex; justify-content:space-between; gap:10px; margin:6px 0}
          .label{color:#666; min-width:140px}
          .val{font-weight:700}
          .hr{height:1px; background:#ccc; margin:14px 0}
          .signs{display:flex; justify-content:space-between; margin-top:40px}
          .sign{border-top:1px solid #999; padding-top:6px; width:180px; text-align:center}
          .muted{color:#666}
          .big{font-size:1.1rem}
        </style>
      </head><body onload="window.print()">
        <div class="voucher">
          <h2>Payment Voucher</h2>
          <div class="row"><div class="label">Voucher No.</div><div class="val">${escapeHtml(rec.voucherNo||'')}</div></div>
          <div class="row"><div class="label">Date</div><div class="val">${fmt.dateDisplay(rec.date)}</div></div>
          <div class="row"><div class="label">Paid To / Ms</div><div class="val">${escapeHtml(rec.paidTo||'')}</div></div>
          <div class="row"><div class="label">Purpose</div><div class="val">${escapeHtml(rec.purpose||'')}</div></div>
          <div class="hr"></div>
          <div class="row big"><div class="label">Amount</div><div class="val">${fmt.currency(rec.amount||0)}</div></div>
          <div class="row"><div class="label">Amount in Words</div><div class="val">${escapeHtml(rec.amountWords||'')}</div></div>
          <div class="signs">
            <div class="sign">Prepared By</div>
            <div class="sign">Verified By</div>
            <div class="sign">Authorized Signatory</div>
          </div>
          <div class="muted" style="margin-top:16px">Generated by Voucher & Expenses Manager</div>
        </div>
      </body></html>`;
    const w = window.open('', '_blank');
    w.document.write(html); w.document.close();
  }

  function exportVouchersXLSX(){
    const data = DB.vouchers.map(v=>({
      'Voucher No': v.voucherNo,
      'Date': v.date,
      'Paid To': v.paidTo,
      'Purpose': v.purpose,
      'Amount': v.amount,
      'Amount in Words': v.amountWords
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Vouchers');
    XLSX.writeFile(wb, 'vouchers.xlsx');
  }

  function exportVouchersCSV(){
    const data = DB.vouchers.map(v=>({
      voucher_no: v.voucherNo, date:v.date, paid_to:v.paidTo, purpose:v.purpose, amount:v.amount, amount_in_words:v.amountWords
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const csv = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vouchers.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // ------------------------------ Advances ------------------------------
  let advSort = { key:'date', dir:'desc' };
  let advSearch = '';
  let selectedAdvanceId = null;

  const aEls = {
    date: ()=>document.getElementById('a-date'),
    month: ()=>document.getElementById('a-month'),
    amount: ()=>document.getElementById('a-amount'),
    remarks: ()=>document.getElementById('a-remarks'),
    table: ()=>document.querySelector('#a-table tbody'),
    total: ()=>document.getElementById('a-total'),
    btnUpdate: ()=>document.getElementById('a-update'),
    btnDelete: ()=>document.getElementById('a-delete')
  };

  function readAdvanceForm(){
    const date = aEls.date().value || fmt.dateISO(new Date());
    return {
      date,
      month: fmt.monthFromDate(date),
      amount: Number(aEls.amount().value||0),
      remarks: aEls.remarks().value.trim()
    };
  }
  function setAdvanceForm(d){
    aEls.date().value = d.date || '';
    aEls.month().value = d.month || '';
    aEls.amount().value = d.amount ?? '';
    aEls.remarks().value = d.remarks || '';
  }
  function clearAdvanceForm(){
    setAdvanceForm({ date: fmt.dateISO(new Date()), month:'', amount:'', remarks:'' });
    selectedAdvanceId=null; aEls.btnUpdate().disabled = true; aEls.btnDelete().disabled = true;
  }
  function addAdvance(){
    const f = readAdvanceForm();
    if(!(f.amount>0)){ showToast('Enter a valid advance amount.'); return; }
    const rec = { id: nextId(), ...f };
    DB.advances.push(rec); saveDB();
    renderAdvancesTable(); renderDashboard();
    showToast('Advance added.'); clearAdvanceForm();
  }
  function updateAdvance(){
    if(!selectedAdvanceId) { showToast('Select an advance row.'); return; }
    const f = readAdvanceForm();
    const idx = DB.advances.findIndex(x=>x.id===selectedAdvanceId);
    if(idx>=0){
      DB.advances[idx] = { ...DB.advances[idx], ...f };
      saveDB(); renderAdvancesTable(); renderDashboard(); showToast('Advance updated.');
    }
  }
  function deleteAdvance(){
    if(!selectedAdvanceId){ showToast('Select an advance row.'); return; }
    if(!confirm('Delete selected advance?')) return;
    DB.advances = DB.advances.filter(x=>x.id!==selectedAdvanceId);
    saveDB(); renderAdvancesTable(); renderDashboard(); showToast('Advance deleted.');
    clearAdvanceForm();
  }

  function renderAdvancesTable(){
    const tbody = aEls.table();
    let rows = DB.advances.slice();
    // search
    const q = advSearch.trim().toLowerCase();
    if(q){ rows = rows.filter(r => Object.values(r).some(v=>(''+v).toLowerCase().includes(q))); }
    // sort
    rows.sort((a,b)=>{
      const k=advSort.key; let va=a[k], vb=b[k];
      if(k==='amount'){ va=Number(va||0); vb=Number(vb||0); }
      if(va<vb) return advSort.dir==='asc'?-1:1;
      if(va>vb) return advSort.dir==='asc'?1:-1;
      return 0;
    });
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id}">
        <td>${fmt.dateDisplay(r.date)}</td>
        <td>${escapeHtml(r.month||'')}</td>
        <td class="right">${fmt.currency(r.amount||0)}</td>
        <td>${escapeHtml(r.remarks||'')}</td>
      </tr>
    `).join('');
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        tbody.querySelectorAll('tr').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        selectedAdvanceId = Number(tr.getAttribute('data-id'));
        const rec = DB.advances.find(x=>x.id===selectedAdvanceId);
        setAdvanceForm(rec);
        aEls.btnUpdate().disabled = false; aEls.btnDelete().disabled = false;
      });
    });
    const tot = rows.reduce((s,r)=>s+Number(r.amount||0),0);
    aEls.total().textContent = fmt.currency(tot);

    document.querySelectorAll('#a-table thead th').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-key');
        if(k){
          if(advSort.key===k) advSort.dir = advSort.dir==='asc'?'desc':'asc';
          else { advSort.key = k; advSort.dir='asc'; }
          renderAdvancesTable();
        }
      };
    });
  }

  // ------------------------------ Expenses ------------------------------
  let expSort = { key:'date', dir:'desc' };
  let expSearch = '';
  let selectedExpenseId = null;

  const eEls = {
    srno: ()=>document.getElementById('e-srno'),
    date: ()=>document.getElementById('e-date'),
    type: ()=>document.getElementById('e-type'),
    desc: ()=>document.getElementById('e-desc'),
    amount: ()=>document.getElementById('e-amount'),
    bill: ()=>document.getElementById('e-bill'),
    remarks: ()=>document.getElementById('e-remarks'),
    table: ()=>document.querySelector('#e-table tbody'),
    total: ()=>document.getElementById('e-total'),
    btnUpdate: ()=>document.getElementById('e-update'),
    btnDelete: ()=>document.getElementById('e-delete')
  };

  function readExpenseForm(){
    return {
      srno: Number(eEls.srno().value||0) || nextExpenseSr(),
      date: eEls.date().value || fmt.dateISO(new Date()),
      type: eEls.type().value.trim(),
      description: eEls.desc().value.trim(),
      amount: Number(eEls.amount().value||0),
      billno: eEls.bill().value.trim(),
      remarks: eEls.remarks().value.trim()
    };
  }
  function setExpenseForm(d){
    eEls.srno().value = d.srno ?? '';
    eEls.date().value = d.date || '';
    eEls.type().value = d.type || '';
    eEls.desc().value = d.description || '';
    eEls.amount().value = d.amount ?? '';
    eEls.bill().value = d.billno || '';
    eEls.remarks().value = d.remarks || '';
  }
  function clearExpenseForm(){
    setExpenseForm({ srno: nextExpenseSr(), date: fmt.dateISO(new Date()), type:'', description:'', amount:'', billno:'', remarks:'' });
    selectedExpenseId = null; eEls.btnUpdate().disabled = true; eEls.btnDelete().disabled = true;
  }
  function addExpense(){
    const f = readExpenseForm();
    if(!f.type || !(f.amount>0)){ showToast('Select/enter a Type and valid Amount.'); return; }
    // maintain nextExpenseSr if user didn't override
    DB.counters.expenseSr = Math.max(DB.counters.expenseSr, (f.srno||0)+1);
    const rec = { id: nextId(), ...f };
    DB.expenses.push(rec); saveDB();
    renderExpensesTable(); renderDashboard(); showToast('Expense added.');
    clearExpenseForm();
    // also add to breakup suggestions if new combination
    if(f.type && f.description && !DB.breakups.some(b=>b.type.toLowerCase()===f.type.toLowerCase() && b.description.toLowerCase()===f.description.toLowerCase())){
      DB.breakups.push({id: nextId(), type:f.type, description:f.description});
      saveDB(); renderBreakupDatalists(); renderBreakupTable();
    }
  }
  function updateExpense(){
    if(!selectedExpenseId){ showToast('Select an expense row.'); return; }
    const f = readExpenseForm();
    const idx = DB.expenses.findIndex(x=>x.id===selectedExpenseId);
    if(idx>=0){
      DB.expenses[idx] = { ...DB.expenses[idx], ...f };
      saveDB(); renderExpensesTable(); renderDashboard(); showToast('Expense updated.');
    }
  }
  function deleteExpense(){
    if(!selectedExpenseId){ showToast('Select an expense row.'); return; }
    if(!confirm('Delete selected expense?')) return;
    DB.expenses = DB.expenses.filter(x=>x.id!==selectedExpenseId);
    saveDB(); renderExpensesTable(); renderDashboard(); showToast('Expense deleted.');
    clearExpenseForm();
  }

  function renderExpensesTable(){
    const tbody = eEls.table();
    let rows = DB.expenses.slice();
    // search
    const q = expSearch.trim().toLowerCase();
    if(q){ rows = rows.filter(r => Object.values(r).some(v=>(''+v).toLowerCase().includes(q))); }
    // sort
    rows.sort((a,b)=>{
      const k=expSort.key; let va=a[k], vb=b[k];
      if(k==='amount' || k==='srno'){ va=Number(va||0); vb=Number(vb||0); }
      if(va<vb) return expSort.dir==='asc'?-1:1;
      if(va>vb) return expSort.dir==='asc'?1:-1;
      return 0;
    });
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id}">
        <td>${escapeHtml(r.srno)}</td>
        <td>${fmt.dateDisplay(r.date)}</td>
        <td>${escapeHtml(r.type||'')}</td>
        <td>${escapeHtml(r.description||'')}</td>
        <td class="right">${fmt.currency(r.amount||0)}</td>
        <td>${escapeHtml(r.billno||'')}</td>
        <td>${escapeHtml(r.remarks||'')}</td>
      </tr>
    `).join('');
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        tbody.querySelectorAll('tr').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        selectedExpenseId = Number(tr.getAttribute('data-id'));
        const rec = DB.expenses.find(x=>x.id===selectedExpenseId);
        setExpenseForm(rec);
        eEls.btnUpdate().disabled = false; eEls.btnDelete().disabled = false;
      });
    });
    const tot = rows.reduce((s,r)=>s+Number(r.amount||0),0);
    eEls.total().textContent = fmt.currency(tot);

    document.querySelectorAll('#e-table thead th').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-key');
        if(k){
          if(expSort.key===k) expSort.dir = expSort.dir==='asc'?'desc':'asc';
          else { expSort.key = k; expSort.dir='asc'; }
          renderExpensesTable();
        }
      };
    });
  }

  // ------------------------------ Breakup ------------------------------
  let bSort = { key:'type', dir:'asc' };
  let bSearch = '';
  let selectedBreakupId = null;

  const bEls = {
    type: ()=>document.getElementById('b-type'),
    desc: ()=>document.getElementById('b-desc'),
    table: ()=>document.querySelector('#b-table tbody'),
    btnUpdate: ()=>document.getElementById('b-update'),
    btnDelete: ()=>document.getElementById('b-delete'),
  };

  function addBreakup(){
    const type = bEls.type().value.trim();
    const desc = bEls.desc().value.trim();
    if(!type || !desc){ showToast('Enter Type and Description.'); return; }
    if(DB.breakups.some(b=>b.type.toLowerCase()===type.toLowerCase() && b.description.toLowerCase()===desc.toLowerCase())){
      showToast('This Type + Description already exists.'); return;
    }
    DB.breakups.push({ id: nextId(), type, description:desc });
    saveDB(); renderBreakupTable(); renderBreakupDatalists(); showToast('Breakup added.');
    bEls.type().value = ''; bEls.desc().value='';
    bEls.btnUpdate().disabled = true; bEls.btnDelete().disabled = true; selectedBreakupId=null;
  }
  function updateBreakup(){
    if(!selectedBreakupId){ showToast('Select a breakup row.'); return; }
    const t = bEls.type().value.trim(); const d = bEls.desc().value.trim();
    if(!t || !d){ showToast('Enter Type and Description.'); return; }
    const idx = DB.breakups.findIndex(x=>x.id===selectedBreakupId);
    if(idx>=0){
      DB.breakups[idx] = { ...DB.breakups[idx], type:t, description:d };
      saveDB(); renderBreakupTable(); renderBreakupDatalists(); showToast('Breakup updated.');
    }
  }
  function deleteBreakup(){
    if(!selectedBreakupId){ showToast('Select a breakup row.'); return; }
    if(!confirm('Delete selected breakup?')) return;
    DB.breakups = DB.breakups.filter(x=>x.id!==selectedBreakupId);
    saveDB(); renderBreakupTable(); renderBreakupDatalists(); showToast('Breakup deleted.');
    bEls.type().value=''; bEls.desc().value=''; selectedBreakupId=null; bEls.btnUpdate().disabled=true; bEls.btnDelete().disabled=true;
  }

  function renderBreakupTable(){
    const tbody = bEls.table();
    let rows = DB.breakups.slice();
    const q = bSearch.trim().toLowerCase();
    if(q){ rows = rows.filter(r => (r.type+' '+r.description).toLowerCase().includes(q)); }
    rows.sort((a,b)=>{
      const k=bSort.key; let va=(a[k]||'').toLowerCase(), vb=(b[k]||'').toLowerCase();
      if(va<vb) return bSort.dir==='asc'?-1:1;
      if(va>vb) return bSort.dir==='asc'?1:-1;
      return 0;
    });
    tbody.innerHTML = rows.map(r=>`
      <tr data-id="${r.id}">
        <td>${escapeHtml(r.type)}</td>
        <td>${escapeHtml(r.description)}</td>
      </tr>
    `).join('');
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        tbody.querySelectorAll('tr').forEach(x=>x.classList.remove('selected'));
        tr.classList.add('selected');
        selectedBreakupId = Number(tr.getAttribute('data-id'));
        const rec = DB.breakups.find(x=>x.id===selectedBreakupId);
        bEls.type().value = rec.type; bEls.desc().value = rec.description;
        bEls.btnUpdate().disabled=false; bEls.btnDelete().disabled=false;
      });
    });
    document.querySelectorAll('#b-table thead th').forEach(th=>{
      th.onclick = ()=>{
        const k = th.getAttribute('data-key');
        if(k){
          if(bSort.key===k) bSort.dir = bSort.dir==='asc'?'desc':'asc';
          else { bSort.key = k; bSort.dir='asc'; }
          renderBreakupTable();
        }
      };
    });
  }

  function renderBreakupDatalists(){
    const types = Array.from(new Set(DB.breakups.map(b=>b.type))).sort((a,b)=>a.localeCompare(b));
    const typeList = document.getElementById('type-list');
    typeList.innerHTML = types.map(t=>`<option value="${escapeHtml(t)}"></option>`).join('');
    // descriptions depend on current selected type in expenses form
    const selType = (document.getElementById('e-type').value||'').trim();
    const descs = Array.from(new Set(DB.breakups.filter(b=>!selType || b.type.toLowerCase()===selType.toLowerCase()).map(b=>b.description))).sort((a,b)=>a.localeCompare(b));
    const descList = document.getElementById('desc-list');
    descList.innerHTML = descs.map(d=>`<option value="${escapeHtml(d)}"></option>`).join('');
  }

  // ------------------------------ Dashboard ------------------------------
  let pieChart = null;
  function totals(){
    const voucherSum = DB.vouchers.reduce((s,r)=>s+Number(r.amount||0),0);
    const adv = DB.advances.reduce((s,r)=>s+Number(r.amount||0),0);
    const exp = DB.expenses.reduce((s,r)=>s+Number(r.amount||0),0);
    const balance = adv - exp;
    return { voucherCount: DB.vouchers.length, voucherSum, adv, exp, balance };
  }
  function renderDashboard(){
    const t = totals();
    document.getElementById('d-voucher-count').textContent = t.voucherCount;
    document.getElementById('d-voucher-amount').textContent = fmt.currency(t.voucherSum);
    document.getElementById('d-adv').textContent = fmt.currency(t.adv);
    document.getElementById('d-exp').textContent = fmt.currency(t.exp);
    document.getElementById('d-balance').textContent = (t.balance>=0 ? '' : '-') + fmt.currency(Math.abs(t.balance));
    const ctx = document.getElementById('pieChart');
    const expenses = t.exp;
    const balancePositive = Math.max(0, t.adv - t.exp);
    const deficit = Math.max(0, t.exp - t.adv);
    const showDeficit = deficit>0;
    document.getElementById('deficit-note').style.display = showDeficit?'inline-flex':'none';
    const data = {
      labels: showDeficit ? ['Expenses','Deficit'] : ['Expenses','Balance'],
      datasets: [{
        data: [ showDeficit ? expenses : expenses, showDeficit ? deficit : balancePositive ],
        backgroundColor: showDeficit ? ['#ef4444','#f59e0b'] : ['#3b82f6','#22c55e'],
        borderWidth: 0
      }]
    };
    if(pieChart){ pieChart.data = data; pieChart.update(); }
    else {
      pieChart = new Chart(ctx, {
        type:'doughnut',
        data,
        options:{
          plugins:{ legend:{ labels:{ color:'#cbd5e1' } } },
          cutout:'55%'
        }
      });
    }
  }

  // ------------------------------ Printing Reports ------------------------------
  function printTableReport(title, columns, rows){
    const headers = columns.map(c=>`<th style="text-align:${c.right?'right':'left'}">${escapeHtml(c.title)}</th>`).join('');
    const trs = rows.map(r=>{
      const tds = columns.map(c=>{
        const val = typeof c.value==='function'? c.value(r) : r[c.key];
        return `<td style="padding:8px 10px; border-bottom:1px solid #ddd; text-align:${c.right?'right':'left'}">${escapeHtml(val??'')}</td>`;
      }).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    const html = `
      <html><head><title>${escapeHtml(title)}</title>
      <style>
        body{font-family:Inter,Arial; padding:24px; color:#111}
        h2{margin:0 0 12px 0}
        table{width:100%; border-collapse:collapse; border:1px solid #ccc}
        th{background:#f3f4f6; text-align:left; padding:8px 10px; border-bottom:1px solid #ccc}
      </style>
      </head><body onload="window.print()">
        <h2>${escapeHtml(title)}</h2>
        <table>
          <thead><tr>${headers}</tr></thead>
          <tbody>${trs}</tbody>
        </table>
      </body></html>`;
    const w = window.open('', '_blank'); w.document.write(html); w.document.close();
  }

  // ------------------------------ Utilities ------------------------------
  function escapeHtml(s){
    return (''+s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }
  function setSubtab(name){
    document.querySelectorAll('.subtab').forEach(b=>b.classList.toggle('active', b.dataset.subtab===name));
    document.querySelectorAll('.subpage').forEach(p=>p.classList.remove('active'));
    document.getElementById('subtab-'+name).classList.add('active');
    if(name==='advance') renderAdvancesTable();
    if(name==='expenses') { renderBreakupDatalists(); renderExpensesTable(); }
    if(name==='breakup') renderBreakupTable();
  }

  // ------------------------------ Event Wiring ------------------------------
  function wireEvents(){
    // Navbar
    document.querySelectorAll('.nav a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        Router.go(a.dataset.route);
      });
    });

    // Voucher actions
    document.getElementById('v-add').onclick = addVoucher;
    document.getElementById('v-update').onclick = updateVoucher;
    document.getElementById('v-delete').onclick = deleteVoucher;
    document.getElementById('v-print').onclick = printVoucher;
    document.getElementById('v-search').oninput = (e)=>{ voucherSearch = e.target.value; renderVouchersTable(); };
    document.getElementById('v-amount').addEventListener('input', ()=> vEls.amountWords().value = numberToWordsIndian(Number(vEls.amount().value||0)));
    // Export dropdown
    const dd = document.getElementById('v-export').parentElement;
    document.getElementById('v-export').onclick = ()=> dd.classList.toggle('open');
    document.body.addEventListener('click', (e)=>{ if(!dd.contains(e.target)) dd.classList.remove('open'); });
    document.getElementById('v-export-xlsx').onclick = ()=>{ exportVouchersXLSX(); dd.classList.remove('open'); };
    document.getElementById('v-export-csv').onclick = ()=>{ exportVouchersCSV(); dd.classList.remove('open'); };

    // Advances
    document.getElementById('a-add').onclick = addAdvance;
    document.getElementById('a-update').onclick = updateAdvance;
    document.getElementById('a-delete').onclick = deleteAdvance;
    document.getElementById('a-search').oninput = (e)=>{ advSearch = e.target.value; renderAdvancesTable(); };
    document.getElementById('a-date').onchange = ()=>{ document.getElementById('a-month').value = fmt.monthFromDate(document.getElementById('a-date').value); };
    document.getElementById('a-print').onclick = ()=>{
      const rows = DB.advances.slice().sort((a,b)=>a.date<b.date?-1:1);
      printTableReport('Advance Report', [
        {title:'Date', key:'date', value:r=>fmt.dateDisplay(r.date)},
        {title:'Month', key:'month'},
        {title:'Amount', key:'amount', value:r=>fmt.currency(r.amount), right:true},
        {title:'Remarks', key:'remarks'}
      ], rows);
    };

    // Expenses
    document.getElementById('e-add').onclick = addExpense;
    document.getElementById('e-update').onclick = updateExpense;
    document.getElementById('e-delete').onclick = deleteExpense;
    document.getElementById('e-search').oninput = (e)=>{ expSearch = e.target.value; renderExpensesTable(); };
    document.getElementById('e-type').addEventListener('input', renderBreakupDatalists);
    document.getElementById('e-print').onclick = ()=>{
      const rows = DB.expenses.slice().sort((a,b)=>a.date<b.date?-1:1);
      printTableReport('Expenses Report', [
        {title:'Sr.No', key:'srno'},
        {title:'Date', key:'date', value:r=>fmt.dateDisplay(r.date)},
        {title:'Type', key:'type'},
        {title:'Description', key:'description'},
        {title:'Amount', key:'amount', value:r=>fmt.currency(r.amount), right:true},
        {title:'Bill No', key:'billno'},
        {title:'Remarks', key:'remarks'}
      ], rows);
    };

    // Breakup
    document.getElementById('b-add').onclick = addBreakup;
    document.getElementById('b-update').onclick = updateBreakup;
    document.getElementById('b-delete').onclick = deleteBreakup;
    document.getElementById('b-search').oninput = (e)=>{ bSearch = e.target.value; renderBreakupTable(); };
  }

  // ------------------------------ Init ------------------------------
  function init(){
    loadDB();
    wireEvents();
    // Default dates + numbers
    ensureVoucherNo();
    document.getElementById('v-date').value = fmt.dateISO(new Date());
    document.getElementById('a-date').value = fmt.dateISO(new Date());
    document.getElementById('a-month').value = fmt.monthFromDate(document.getElementById('a-date').value);
    document.getElementById('e-srno').value = DB.counters.expenseSr;
    document.getElementById('e-date').value = fmt.dateISO(new Date());
    renderBreakupDatalists();
    renderVouchersTable();
    renderAdvancesTable();
    renderExpensesTable();
    renderBreakupTable();
   
    // Route from hash
    const route = location.hash.replace('#','') || 'home';
    Router.render(route);
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
